<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-Vendor EVPN VXLAN Integration - Cisco / Versa / Cumulus</title>
<style>
@page {
    margin: 0.8in;
    size: A4;
}
* {
    box-sizing: border-box;
}
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 40px 60px;
    line-height: 1.7;
    color: #2c3e50;
    background: #fff;
    font-size: 11pt;
}

/* Header Section */
.header {
    background: linear-gradient(135deg, #0d47a1 0%, #1565c0 50%, #1976d2 100%);
    color: white;
    padding: 40px;
    margin: -40px -60px 40px -60px;
    text-align: center;
}
.header h1 {
    margin: 0 0 10px 0;
    font-size: 26pt;
    font-weight: 600;
    letter-spacing: -0.5px;
}
.header .subtitle {
    font-size: 14pt;
    opacity: 0.9;
    margin-bottom: 20px;
}
.header .meta {
    font-size: 10pt;
    opacity: 0.8;
}
.header .classification {
    display: inline-block;
    background: rgba(255,255,255,0.2);
    padding: 4px 16px;
    border-radius: 4px;
    font-size: 9pt;
    font-weight: 600;
    letter-spacing: 1px;
    margin-top: 12px;
    border: 1px solid rgba(255,255,255,0.4);
}

/* Section Headers */
h2 {
    color: #0d47a1;
    font-size: 16pt;
    font-weight: 600;
    border-left: 4px solid #1976d2;
    padding-left: 15px;
    margin: 35px 0 20px 0;
    page-break-after: avoid;
}
h3 {
    color: #1565c0;
    font-size: 12pt;
    font-weight: 600;
    margin: 25px 0 15px 0;
    page-break-after: avoid;
}
h4 {
    color: #37474f;
    font-size: 11pt;
    font-weight: 600;
    margin: 20px 0 10px 0;
}

/* Tables */
table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 10pt;
    page-break-inside: avoid;
}
th {
    background: #1565c0;
    color: white;
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    border: none;
}
td {
    padding: 10px 15px;
    border-bottom: 1px solid #e0e0e0;
}
tr:nth-child(even) {
    background: #f8f9fa;
}
tr:hover {
    background: #e3f2fd;
}

/* Code blocks */
pre {
    background: #263238;
    color: #eceff1;
    padding: 20px;
    border-radius: 6px;
    overflow-x: auto;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 9pt;
    line-height: 1.5;
    margin: 15px 0;
    page-break-inside: avoid;
    border-left: 4px solid #1976d2;
}
pre.cisco {
    border-left-color: #00897b;
}
pre.cumulus {
    border-left-color: #7cb342;
}
pre.versa {
    border-left-color: #f57c00;
}
pre.pcap {
    border-left-color: #e53935;
    background: #1a1a2e;
}
code {
    background: #eceff1;
    color: #c62828;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 9pt;
}

/* Network Diagram */
.diagram-container {
    background: #fafafa;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 25px;
    margin: 20px 0;
    text-align: center;
}
.diagram {
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 8.5pt;
    white-space: pre;
    display: inline-block;
    text-align: left;
    line-height: 1.3;
    color: #37474f;
}

/* Alert boxes */
.info-box {
    background: #e3f2fd;
    border-left: 4px solid #1976d2;
    padding: 15px 20px;
    margin: 20px 0;
    border-radius: 0 6px 6px 0;
}
.info-box strong {
    color: #0d47a1;
}
.success-box {
    background: #e8f5e9;
    border-left: 4px solid #43a047;
    padding: 15px 20px;
    margin: 20px 0;
    border-radius: 0 6px 6px 0;
}
.success-box strong {
    color: #2e7d32;
}
.warning-box {
    background: #fff8e1;
    border-left: 4px solid #ffa000;
    padding: 15px 20px;
    margin: 20px 0;
    border-radius: 0 6px 6px 0;
}
.warning-box strong {
    color: #e65100;
}
.danger-box {
    background: #ffebee;
    border-left: 4px solid #e53935;
    padding: 15px 20px;
    margin: 20px 0;
    border-radius: 0 6px 6px 0;
}
.danger-box strong {
    color: #b71c1c;
}

/* Lists */
ul {
    margin: 10px 0;
    padding-left: 25px;
}
li {
    margin: 5px 0;
}

/* Page breaks */
.page-break {
    page-break-before: always;
    margin-top: 40px;
}

/* Footer */
.footer {
    margin-top: 50px;
    padding-top: 20px;
    border-top: 2px solid #e0e0e0;
    text-align: center;
    color: #78909c;
    font-size: 9pt;
}

/* Two column layout */
.two-col {
    display: flex;
    gap: 30px;
    margin: 20px 0;
}
.two-col > div {
    flex: 1;
}

/* Badge style */
.badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 9pt;
    font-weight: 600;
}
.badge-success {
    background: #c8e6c9;
    color: #2e7d32;
}
.badge-info {
    background: #bbdefb;
    color: #1565c0;
}
.badge-warning {
    background: #fff3e0;
    color: #e65100;
}
.badge-danger {
    background: #ffcdd2;
    color: #b71c1c;
}

/* TOC */
.toc {
    background: #f5f5f5;
    padding: 25px;
    border-radius: 8px;
    margin: 30px 0;
    column-count: 2;
    column-gap: 40px;
}
.toc h3 {
    margin-top: 0;
    color: #0d47a1;
    column-span: all;
}
.toc ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}
.toc li {
    padding: 4px 0;
    border-bottom: 1px dotted #ccc;
    break-inside: avoid;
}
.toc a {
    color: #1565c0;
    text-decoration: none;
}
.toc a:hover {
    text-decoration: underline;
}

/* Hex dump styling */
.hex-highlight-red {
    color: #ff5252;
    font-weight: bold;
}
.hex-highlight-green {
    color: #69f0ae;
    font-weight: bold;
}
.hex-highlight-blue {
    color: #82b1ff;
    font-weight: bold;
}

/* Vendor tags */
.vendor-tag {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 8pt;
    font-weight: 600;
    margin-right: 4px;
}
.vendor-cisco { background: #00897b; color: white; }
.vendor-versa { background: #f57c00; color: white; }
.vendor-cumulus { background: #7cb342; color: white; }

/* VXLAN header diagram */
.bit-diagram {
    font-family: 'Consolas', monospace;
    font-size: 9pt;
    background: #fafafa;
    border: 1px solid #e0e0e0;
    padding: 15px;
    border-radius: 6px;
    margin: 15px 0;
    overflow-x: auto;
}
</style>
</head>
<body>

<div class="header">
    <h1>Multi-Vendor EVPN VXLAN Fabric</h1>
    <div class="subtitle">Cisco Catalyst 9K / Versa FlexVNF / Cumulus Linux (NVIDIA) Integration</div>
    <div class="meta">
        <strong>Version:</strong> 2.0 &nbsp;|&nbsp;
        <strong>Date:</strong> February 10, 2026 &nbsp;|&nbsp;
        <strong>Author:</strong> Network Engineering Team
    </div>
    <div class="classification">INTERNAL - ENGINEERING REFERENCE</div>
</div>

<div class="toc">
    <h3>Table of Contents</h3>
    <ul>
        <li><a href="#s1">1. Executive Summary</a></li>
        <li><a href="#s2">2. Network Topology</a></li>
        <li><a href="#s3">3. Device Inventory</a></li>
        <li><a href="#s4">4. VLAN and VNI Mapping</a></li>
        <li><a href="#s5">5. Underlay Configuration (OSPF)</a></li>
        <li><a href="#s6">6. BGP EVPN Overlay Configuration</a></li>
        <li><a href="#s7">7. L2VPN EVPN Instance Configuration</a></li>
        <li><a href="#s8">8. Cumulus Linux (NVIDIA) Configuration</a></li>
        <li><a href="#s9">9. NVE Peer Verification</a></li>
        <li><a href="#s10">10. MAC Address Learning</a></li>
        <li><a href="#s11">11. VXLAN-GBP Interoperability Issue</a></li>
        <li><a href="#s12">12. VXLAN-GBP Fix &amp; Resolution</a></li>
        <li><a href="#s13">13. Troubleshooting Commands</a></li>
        <li><a href="#s14">14. Summary &amp; Lessons Learned</a></li>
    </ul>
</div>

<!-- ===================== SECTION 1 ===================== -->
<h2 id="s1">1. Executive Summary</h2>

<p>This document describes the integration of a multi-vendor BGP EVPN VXLAN fabric consisting of <strong>Cisco Catalyst 9000</strong>, <strong>Versa FlexVNF SD-WAN</strong>, and <strong>Cumulus Linux (NVIDIA)</strong> switches. The fabric provides Layer 2 extension of VLAN 1151 (VNI 401151) across all four leaf VTEPs using standard EVPN Type-2 (MAC/IP) and Type-3 (IMET) routes with ingress replication.</p>

<p>This document also covers a critical <strong>VXLAN-GBP (Group Based Policy) interoperability issue</strong> discovered during Cumulus-to-Versa traffic testing, including packet capture evidence, root cause analysis, and the resolution applied.</p>

<div class="two-col">
    <div>
        <h4>Key Components</h4>
        <ul>
            <li><span class="vendor-tag vendor-cisco">Cisco</span> 3x Catalyst 9300 (sw1 Spine/RR, sw2/sw3 Leaf)</li>
            <li><span class="vendor-tag vendor-versa">Versa</span> 1x FlexVNF 22.1.4 (SD-WAN Leaf)</li>
            <li><span class="vendor-tag vendor-cumulus">Cumulus</span> 1x Cumulus Linux 5.x / NVIDIA (Leaf)</li>
            <li>BGP AS: 6500 (iBGP with RR)</li>
            <li>OSPF Area: 100 (Underlay)</li>
        </ul>
    </div>
    <div>
        <h4>Integration Status</h4>
        <ul>
            <li><span class="badge badge-success">OSPF Adjacency</span> All neighbors FULL</li>
            <li><span class="badge badge-success">BGP EVPN</span> All peers established</li>
            <li><span class="badge badge-success">VXLAN Tunnels</span> 4 VTEPs active</li>
            <li><span class="badge badge-success">MAC Learning</span> Cross-vendor working</li>
            <li><span class="badge badge-warning">VXLAN-GBP</span> Versa sends GBP headers (resolved)</li>
        </ul>
    </div>
</div>

<!-- ===================== SECTION 2 ===================== -->
<h2 id="s2">2. Network Topology</h2>

<div class="diagram-container">
<div class="diagram">
                              +---------------------------+
                              |    sw1 - Spine / BGP RR   |
                              |    Catalyst 9300          |
                              |    Loopback: 1.1.1.1      |
                              |    Mgmt: 192.168.20.77    |
                              +--+------+------+------+---+
                                 |      |      |      |
                              Gi1/0/1 Gi1/0/2 Gi1/0/3 Gi1/0/4
                            12.12.12.1 .5    .9     .13
                                 |      |      |      |
                            12.12.12.2 .6    .10    .14
                                 |      |      |      |
                 +---------------+      |      |      +------------------+
                 |                      |      |                         |
       +---------+----------+  +--------+--------+  +---------+----------+  +----------+---------+
       |  sw2 - Leaf VTEP   |  |  sw3 - Leaf VTEP|  |  VERSA FlexVNF    |  | Cumulus_Nvidia      |
       |  Catalyst 9300     |  |  Catalyst 9300   |  |  SD-WAN VTEP      |  | Cumulus Linux 5.x   |
       |  Lo: 1.1.1.2       |  |  Lo: 1.1.1.3    |  |  VTEP: 1.1.1.4    |  | Lo: 1.1.1.5         |
       |  Mgmt: 192.168.20.76  |  Mgmt: 192.168.20.81  |  Mgmt: 192.168.20.166  |  Mgmt: 192.168.20.172 |
       +---------+----------+  +--------+--------+  +---------+----------+  +----------+---------+
                 |                      |                      |                         |
            Gi1/0/4               Gi1/0/4               Vni-0/1                      Swp2
           VLAN 1151             VLAN 1151             VLAN 1151                    VLAN 1151
                 |                      |                      |                         |
          +------+------+       +------+------+        +------+------+           +------+------+
          |Test_Client_SW|       |Test_Client_SW_2|      |Test_Client_SW_3|         | iol-0        |
          |192.168.1.22  |       |192.168.1.22    |      |192.168.1.10    |         |192.168.1.12  |
          +--------------+       +--------------+        +--------------+           +--------------+
</div>
</div>

<!-- ===================== SECTION 3 ===================== -->
<h2 id="s3">3. Device Inventory</h2>

<table>
    <tr>
        <th>Device</th>
        <th>Role</th>
        <th>Platform</th>
        <th>Loopback/VTEP</th>
        <th>OSPF RID</th>
        <th>BGP AS</th>
        <th>Mgmt IP</th>
    </tr>
    <tr>
        <td><strong>sw1</strong></td>
        <td>Spine / BGP RR</td>
        <td>Catalyst 9300</td>
        <td>1.1.1.1</td>
        <td>1.1.1.1</td>
        <td>6500</td>
        <td>192.168.20.77</td>
    </tr>
    <tr>
        <td><strong>sw2</strong></td>
        <td>Leaf VTEP</td>
        <td>Catalyst 9300</td>
        <td>1.1.1.2</td>
        <td>1.1.1.2</td>
        <td>6500</td>
        <td>192.168.20.76</td>
    </tr>
    <tr>
        <td><strong>sw3</strong></td>
        <td>Leaf VTEP</td>
        <td>Catalyst 9300</td>
        <td>1.1.1.3</td>
        <td>1.1.1.3</td>
        <td>6500</td>
        <td>192.168.20.81</td>
    </tr>
    <tr>
        <td><strong>Versa</strong></td>
        <td>SD-WAN VTEP</td>
        <td>FlexVNF 22.1.4</td>
        <td>1.1.1.4</td>
        <td>12.12.12.10</td>
        <td>6500</td>
        <td>192.168.20.166</td>
    </tr>
    <tr>
        <td><strong>Cumulus_Nvidia</strong></td>
        <td>Leaf VTEP</td>
        <td>Cumulus Linux 5.x</td>
        <td>1.1.1.5</td>
        <td>1.1.1.5</td>
        <td>6500</td>
        <td>192.168.20.172</td>
    </tr>
</table>

<h3>3.1 Underlay Point-to-Point Links</h3>

<table>
    <tr>
        <th>Link</th>
        <th>sw1 Interface</th>
        <th>sw1 IP</th>
        <th>Remote Interface</th>
        <th>Remote IP</th>
        <th>Subnet</th>
    </tr>
    <tr>
        <td>sw1 &harr; sw2</td>
        <td>Gi1/0/1</td>
        <td>12.12.12.1</td>
        <td>Gi1/0/1</td>
        <td>12.12.12.2</td>
        <td>12.12.12.0/30</td>
    </tr>
    <tr>
        <td>sw1 &harr; sw3</td>
        <td>Gi1/0/2</td>
        <td>12.12.12.5</td>
        <td>Gi1/0/1</td>
        <td>12.12.12.6</td>
        <td>12.12.12.4/30</td>
    </tr>
    <tr>
        <td>sw1 &harr; Versa</td>
        <td>Gi1/0/3</td>
        <td>12.12.12.9</td>
        <td>Vni-0/2</td>
        <td>12.12.12.10</td>
        <td>12.12.12.8/30</td>
    </tr>
    <tr>
        <td>sw1 &harr; Cumulus</td>
        <td>Gi1/0/4</td>
        <td>12.12.12.13</td>
        <td>swp1</td>
        <td>12.12.12.14</td>
        <td>12.12.12.12/30</td>
    </tr>
</table>

<!-- ===================== SECTION 4 ===================== -->
<h2 id="s4">4. VLAN and VNI Mapping</h2>

<table>
    <tr>
        <th>VLAN</th>
        <th>Name</th>
        <th>VNI</th>
        <th>Subnet</th>
        <th>Purpose</th>
        <th>Devices</th>
    </tr>
    <tr>
        <td>1101</td>
        <td>VRF1_CORE_VLAN</td>
        <td>50101</td>
        <td>-</td>
        <td>L3VNI (Core Routing)</td>
        <td>sw2, sw3</td>
    </tr>
    <tr>
        <td><strong>1151</strong></td>
        <td>VRF1_ACCESS_VLAN</td>
        <td><strong>401151</strong></td>
        <td>192.168.1.0/25</td>
        <td><strong>L2 Extension (All VTEPs)</strong></td>
        <td><strong>sw2, sw3, Versa, Cumulus</strong></td>
    </tr>
    <tr>
        <td>1152</td>
        <td>VRF1_ACCESS_VLAN_2</td>
        <td>401152</td>
        <td>192.168.2.0/25</td>
        <td>Access VLAN</td>
        <td>sw2, sw3</td>
    </tr>
    <tr>
        <td>1153</td>
        <td>VRF1_ACCESS_VLAN_3</td>
        <td>401153</td>
        <td>192.168.3.0/25</td>
        <td>Access VLAN</td>
        <td>sw2, sw3</td>
    </tr>
</table>

<div class="page-break"></div>

<!-- ===================== SECTION 5 ===================== -->
<h2 id="s5">5. Underlay Configuration (OSPF)</h2>

<h3>5.1 sw1 OSPF and Interface Configuration (Spine)</h3>
<pre class="cisco">! sw1 - OSPF underlay
router ospf 100
 router-id 1.1.1.1
 auto-cost reference-bandwidth 100000
 timers throttle spf 10 100 5000
 timers lsa arrival 80
!
interface Loopback0
 ip address 1.1.1.1 255.255.255.255
 ip ospf 100 area 100
!
interface GigabitEthernet1/0/1
 description to sw2
 no switchport
 ip address 12.12.12.1 255.255.255.252
 ip ospf network point-to-point
 ip ospf 100 area 100
!
interface GigabitEthernet1/0/2
 description to sw3
 no switchport
 ip address 12.12.12.5 255.255.255.252
 ip ospf network point-to-point
 ip ospf 100 area 100
!
interface GigabitEthernet1/0/3
 description to Versa FlexVNF
 no switchport
 ip address 12.12.12.9 255.255.255.252
 ip mtu 1550
 ip ospf network point-to-point
 ip ospf mtu-ignore
 ip ospf 100 area 100
!
interface GigabitEthernet1/0/4
 description to Cumulus_Nvidia
 no switchport
 ip address 12.12.12.13 255.255.255.252
 ip mtu 1550
 ip ospf network point-to-point
 ip ospf mtu-ignore
 ip ospf 100 area 100</pre>

<div class="warning-box">
    <strong>MTU Mismatch Note:</strong> Cumulus Linux defaults to MTU 9216. Cisco uses MTU 1550 on the link. To prevent OSPF ExStart/DBD issues, <code>ip ospf mtu-ignore</code> is configured on both ends. Alternatively, match MTU on both sides.
</div>

<h3>5.2 Versa Underlay OSPF Configuration</h3>
<pre class="versa">routing-instances routing-instance Underlay {
    instance-type virtual-router
    networks      [ OSPF_Underlay ]
    evpn-core
    interfaces    [ tvi-0/9005.0 ]

    policy-options {
        redistribution-policy Export-Vtep-To-OSPF {
            term VTEP_IP {
                match { address 1.1.1.4/32 }
                action { accept }
            }
        }
        redistribute-to-ospf Export-Vtep-To-OSPF
    }

    protocols {
        ospf 4023 {
            router-id     12.12.12.10
            area 100 {
                network-name OSPF_Underlay {
                    network-type    point-to-point
                    hello-interval  10
                    dead-interval   40
                }
            }
        }
    }
}</pre>

<h3>5.3 OSPF Neighbor Verification (sw1)</h3>
<pre class="cisco">sw1# show ip ospf neighbor

Neighbor ID     Pri   State           Dead Time   Address         Interface
12.12.12.10       0   FULL/  -        00:00:32    12.12.12.10     GigabitEthernet1/0/3
1.1.1.3           0   FULL/  -        00:00:39    12.12.12.6      GigabitEthernet1/0/2
1.1.1.2           0   FULL/  -        00:00:31    12.12.12.2      GigabitEthernet1/0/1
1.1.1.5           0   FULL/  -        00:00:37    12.12.12.14     GigabitEthernet1/0/4</pre>

<div class="success-box">
    <strong>OSPF Status:</strong> All four OSPF adjacencies are FULL &mdash; sw2 (1.1.1.2), sw3 (1.1.1.3), Versa (12.12.12.10), Cumulus (1.1.1.5).
</div>

<div class="page-break"></div>

<!-- ===================== SECTION 6 ===================== -->
<h2 id="s6">6. BGP EVPN Overlay Configuration</h2>

<h3>6.1 sw1 BGP Configuration (Route Reflector)</h3>
<pre class="cisco">router bgp 6500
 bgp router-id interface Loopback0
 bgp log-neighbor-changes
 !
 template peer-session spine-peer-session
  remote-as 6500
  update-source Loopback0
 exit-peer-session
 !
 ! Cisco Leaf VTEPs
 neighbor 1.1.1.2 inherit peer-session spine-peer-session
 neighbor 1.1.1.3 inherit peer-session spine-peer-session
 !
 ! Versa FlexVNF VTEP
 neighbor 1.1.1.4 inherit peer-session spine-peer-session
 neighbor 1.1.1.4 send-community both
 !
 ! Cumulus Nvidia VTEP
 neighbor 1.1.1.5 inherit peer-session spine-peer-session
 neighbor 1.1.1.5 send-community both
 !
 address-family l2vpn evpn
  neighbor 1.1.1.2 activate
  neighbor 1.1.1.2 send-community both
  neighbor 1.1.1.2 route-reflector-client
  !
  neighbor 1.1.1.3 activate
  neighbor 1.1.1.3 send-community both
  !
  neighbor 1.1.1.4 activate
  neighbor 1.1.1.4 send-community both
  neighbor 1.1.1.4 route-reflector-client
  !
  neighbor 1.1.1.5 activate
  neighbor 1.1.1.5 send-community both
  neighbor 1.1.1.5 route-reflector-client
 exit-address-family</pre>

<h3>6.2 Versa BGP EVPN Configuration</h3>
<pre class="versa">routing-instances routing-instance Underlay {
    protocols {
        bgp 3023 {
            router-id     1.1.1.4
            local-as { as-number 64515 }
            group vxlan_internal {
                type     internal
                family { l2vpn { evpn } }
                local-as 6500
                neighbor 1.1.1.1 {
                    local-address tvi-0/9005.0
                }
            }
        }
    }
}</pre>

<div class="info-box">
    <strong>Note:</strong> Versa uses <code>local-as 6500</code> override to match the Cisco fabric AS number while maintaining its own internal AS (64515).
</div>

<h3>6.3 BGP EVPN Verification - sw1</h3>
<pre class="cisco">sw1# show bgp l2vpn evpn summary
BGP router identifier 1.1.1.1, local AS number 6500

Neighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
1.1.1.2         4         6500     224     290      106    0    0 03:03:30       18
1.1.1.3         4         6500     234     233      106    0    0 03:04:07       15
1.1.1.4         4         6500     429     454      106    0    0 03:03:42        1
1.1.1.5         4         6500    1148    1130        0    0    0 00:48:57        2</pre>

<div class="success-box">
    <strong>BGP Status:</strong> All four EVPN peers established. Cumulus advertises 2 routes (1x Type-2 MAC/IP + 1x Type-3 IMET). Versa advertises 1 route (Type-3 IMET).
</div>

<div class="page-break"></div>

<!-- ===================== SECTION 7 ===================== -->
<h2 id="s7">7. L2VPN EVPN Instance Configuration</h2>

<h3>7.1 Route Target Mapping</h3>

<table>
    <tr>
        <th>Device</th>
        <th>Route Distinguisher</th>
        <th>Export RT</th>
        <th>Import RT</th>
    </tr>
    <tr>
        <td><span class="vendor-tag vendor-cisco">Cisco</span> sw2</td>
        <td>1.1.1.2:1151 (auto)</td>
        <td>1151:1</td>
        <td>1151:1, 65000:1151, <strong>2:2</strong></td>
    </tr>
    <tr>
        <td><span class="vendor-tag vendor-cisco">Cisco</span> sw3</td>
        <td>1.1.1.3:1151 (auto)</td>
        <td>1151:1</td>
        <td>1151:1</td>
    </tr>
    <tr>
        <td><span class="vendor-tag vendor-versa">Versa</span></td>
        <td>2L:122</td>
        <td><strong>2:2</strong>, 1151:1</td>
        <td>2:2, 1151:1</td>
    </tr>
    <tr>
        <td><span class="vendor-tag vendor-cumulus">Cumulus</span></td>
        <td>1.1.1.5:2 (auto)</td>
        <td>1151:1</td>
        <td>1151:1</td>
    </tr>
</table>

<div class="warning-box">
    <strong>Critical - Route Target Matching:</strong> Versa exports RT <code>2:2</code> in addition to <code>1151:1</code>. Any device that only imports <code>1151:1</code> will still receive Versa routes. However, sw2 also explicitly imports <code>2:2</code> for completeness.
</div>

<h3>7.2 sw2 L2VPN EVPN Instance</h3>
<pre class="cisco">l2vpn evpn instance 1151 vlan-based
 encapsulation vxlan
 route-target export 1151:1
 route-target import 1151:1
 route-target import 65000:1151
 route-target import 2:2
!
vlan configuration 1151
 member evpn-instance 1151 vni 401151</pre>

<h3>7.3 sw2 NVE Interface</h3>
<pre class="cisco">interface nve1
 no ip address
 source-interface Loopback0
 host-reachability protocol bgp
 member vni 50101 vrf VRF-1
 member vni 401151 ingress-replication
 member vni 401152 ingress-replication local-routing
 member vni 401153 ingress-replication local-routing</pre>

<h3>7.4 Versa Virtual-Switch Configuration</h3>
<pre class="versa">routing-instances routing-instance VERSA-default-switch {
    instance-type       virtual-switch

    bridge-options {
        l2vpn-service-type vlan
    }

    bridge-domains {
        VLAN-1151 {
            vlan-id 1151
            bridge-options {
                bridge-domain-arp-suppression enable
            }
            vxlan {
                vni 401151
            }
        }
    }

    interfaces          [ vni-0/1.1 ]
    route-distinguisher 2L:122
    vrf-both-target     "target:2L:2 target:1151:1"

    protocols {
        evpn {
            vlan-id-list  [ 1151 ]
            encapsulation vxlan
            core-instance Underlay
        }
    }
}</pre>

<div class="page-break"></div>

<!-- ===================== SECTION 8 ===================== -->
<h2 id="s8">8. Cumulus Linux (NVIDIA) Configuration</h2>

<div class="info-box">
    <strong>Platform:</strong> Cumulus Linux 5.x uses <strong>NVUE</strong> (<code>nv set</code>) as the primary configuration method. All commands below are NVUE syntax. Apply with <code>nv config apply -y</code>.
</div>

<h3>8.1 Complete NVUE Configuration</h3>
<pre class="cumulus"># ========================================
# Cumulus Linux (NVIDIA) - NVUE Commands
# Hostname: cumulus | Mgmt: 192.168.20.172
# ========================================

# --- Loopback (VTEP Source) ---
nv set interface lo type loopback
nv set interface lo ip address 1.1.1.5/32

# --- Underlay Link to sw1 (swp1) ---
nv set interface swp1 type swp
nv set interface swp1 link state up
nv set interface swp1 ip address 12.12.12.14/30
nv set interface swp1 link mtu 9216

# --- OSPF Underlay ---
nv set router ospf enable on
nv set router ospf router-id 1.1.1.5
nv set vrf default router ospf enable on
nv set vrf default router ospf router-id 1.1.1.5
nv set interface lo router ospf enable on
nv set interface lo router ospf area 100
nv set interface swp1 router ospf enable on
nv set interface swp1 router ospf area 100
nv set interface swp1 router ospf network-type point-to-point
nv set interface swp1 router ospf mtu-ignore on

# --- BGP EVPN Overlay ---
nv set router bgp enable on
nv set router bgp autonomous-system 6500
nv set router bgp router-id 1.1.1.5
nv set vrf default router bgp enable on
nv set vrf default router bgp neighbor 1.1.1.1 remote-as internal
nv set vrf default router bgp neighbor 1.1.1.1 type numbered
nv set vrf default router bgp neighbor 1.1.1.1 update-source lo
nv set vrf default router bgp address-family l2vpn-evpn enable on
nv set vrf default router bgp neighbor 1.1.1.1 address-family l2vpn-evpn enable on

# --- VXLAN / NVE ---
nv set nve vxlan enable on
nv set nve vxlan source address 1.1.1.5
nv set evpn enable on

# --- Bridge + VLAN 1151 + VNI 401151 ---
nv set bridge domain br_default vlan 1151 vni 401151
nv set evpn vni 401151 route-target export 1151:1
nv set evpn vni 401151 route-target import 1151:1

# --- Access Port (swp2) - Trunk allowing all VLANs ---
nv set interface swp2 type swp
nv set interface swp2 link state up
nv set interface swp2 bridge domain br_default
nv set interface swp2 bridge domain br_default stp admin-edge on
nv set interface swp2 bridge domain br_default stp bpdu-guard on

# --- SVI for VLAN 1151 ---
nv set interface vlan1151 type svi
nv set interface vlan1151 vlan 1151
nv set interface vlan1151 ip address 192.168.1.15/25

# --- Apply Configuration ---
nv config apply -y</pre>

<h3>8.2 NVUE Configuration Verification</h3>

<p>To view the running configuration in NVUE set-based format:</p>
<pre class="cumulus">nv config show --output commands</pre>

<h3>8.3 Cumulus OSPF Verification</h3>
<pre class="cumulus">cumulus@cumulus:~$ sudo vtysh -c "show ip ospf neighbor"

Neighbor ID     Pri State           Dead Time Address         Interface
1.1.1.1           1 Full/DROther      39.892s 12.12.12.13     swp1:12.12.12.14</pre>

<h3>8.4 Cumulus BGP EVPN Verification</h3>
<pre class="cumulus">cumulus@cumulus:~$ sudo vtysh -c "show bgp l2vpn evpn summary"

BGP router identifier 1.1.1.5, local AS number 6500 vrf-id 0
BGP table version 0
RIB entries 17, using 3400 bytes of memory
Peers 1, using 23 KiB of memory

Neighbor        V   AS   MsgRcvd  MsgSent  TblVer InQ OutQ Up/Down  State/PfxRcd  PfxSnt
1.1.1.1         4  6500    1148     1130       0    0    0 00:48:57           25       2</pre>

<h3>8.5 Cumulus EVPN VNI Status</h3>
<pre class="cumulus">cumulus@cumulus:~$ sudo vtysh -c "show evpn vni 401151"

VNI: 401151
 Type: L2
 Vlan: 1151
 Bridge: br_default
 Tenant VRF: default
 VxLAN interface: vxlan48
 VxLAN ifIndex: 14
 Local VTEP IP: 1.1.1.5
 Mcast group: 0.0.0.0
 Remote VTEPs for this VNI:
  1.1.1.4 flood: HER
  1.1.1.3 flood: HER
  1.1.1.2 flood: HER
 Number of MACs (local and remote) known for this VNI: 6
 Number of ARPs (IPv4 and IPv6, local and remote) known for this VNI: 6
 Advertise-gw-macip: No
 Advertise-svi-macip: No</pre>

<h3>8.6 Cumulus Bridge FDB (MAC Table)</h3>
<pre class="cumulus">cumulus@cumulus:~$ bridge fdb show dev vxlan48

aa:bb:cc:00:27:00 dst 1.1.1.3 self extern_learn    # sw3 client
aa:bb:cc:00:24:00 dst 1.1.1.2 self extern_learn    # sw2 client
52:54:00:91:2c:07 dst 1.1.1.3 self extern_learn    # sw3 client 2
52:54:00:c4:b4:a1 dst 1.1.1.2 self extern_learn    # sw2 client 2
00:00:00:00:00:00 dst 1.1.1.2 self permanent       # BUM flooding
00:00:00:00:00:00 dst 1.1.1.3 self permanent       # BUM flooding
00:00:00:00:00:00 dst 1.1.1.4 self permanent       # BUM flooding</pre>

<h3>8.7 Cumulus EVPN ARP Cache</h3>
<pre class="cumulus">cumulus@cumulus:~$ sudo vtysh -c "show evpn arp-cache vni 401151"

Number of ARPs (local and remote) known for this VNI: 3
Neighbor        Type   Flags State    MAC               Remote VTEP
192.168.1.23    remote       inactive aa:bb:cc:00:27:00 1.1.1.3
192.168.1.103   remote       inactive 52:54:00:91:2c:07 1.1.1.3
192.168.1.22    remote       inactive aa:bb:cc:00:24:00 1.1.1.2</pre>

<div class="success-box">
    <strong>Cumulus EVPN Status:</strong> VNI 401151 active with 3 remote VTEPs discovered (sw2: 1.1.1.2, sw3: 1.1.1.3, Versa: 1.1.1.4). All remote MACs learned via EVPN Type-2 routes. HER (Head-End Replication) active for BUM traffic.
</div>

<div class="page-break"></div>

<!-- ===================== SECTION 9 ===================== -->
<h2 id="s9">9. NVE Peer Verification</h2>

<h3>9.1 sw2 NVE Peers for VNI 401151</h3>
<pre class="cisco">sw2# show nve peers vni 401151

Interface  VNI      Type Peer-IP          RMAC/Num_RTs   eVNI     state flags UP time
nve1       401151   L2CP 1.1.1.3          3              401151     UP   N/A  06:01:13
nve1       401151   L2CP 1.1.1.4          1              401151     UP   N/A  00:49:17
nve1       401151   L2CP 1.1.1.5          2              401151     UP   N/A  00:48:57</pre>

<h3>9.2 Cumulus VXLAN Interface Details</h3>
<pre class="cumulus">cumulus@cumulus:~$ ip -d link show vxlan48

14: vxlan48: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9216 qdisc noqueue
    master br_default state UNKNOWN
    link/ether 3a:f9:9b:95:ee:76 brd ff:ff:ff:ff:ff:ff
    vxlan id 401151 local 1.1.1.5 srcport 0 0 dstport 4789
    nolearning ttl 64 ageing 300 udpcsum gbp
    bridge_slave state forwarding priority 8 cost 100
    learning off flood on neigh_suppress on vlan_tunnel on</pre>

<div class="info-box">
    <strong>Key Parameters:</strong> <code>nolearning</code> (data-plane MAC learning disabled, EVPN controls FDB), <code>neigh_suppress</code> (ARP suppression), <code>gbp</code> (VXLAN Group Based Policy enabled - required for Versa interop).
</div>

<div class="page-break"></div>

<!-- ===================== SECTION 10 ===================== -->
<h2 id="s10">10. MAC Address Learning Verification</h2>

<h3>10.1 Versa Bridge Table</h3>
<pre class="versa">admin@Cisco-EVPN-Br1-cli> show bridge

ROUTING              BRIDGE         LOGICAL      MAC-ADDRESS          MAC    VLANID  OR TUNNEL
INSTANCE             NAME           INTERFACE                         TYPE           END POINT
--------------------------------------------------------------------------------------------
VERSA-default-switch VLAN-1151      dtvi-0/56    aa:bb:cc:00:27:00    CA     1151    1.1.1.3
VERSA-default-switch VLAN-1151      dtvi-0/58    aa:bb:cc:00:24:00    CA     1151    1.1.1.2</pre>

<h3>10.2 sw2 EVPN MAC Table</h3>
<pre class="cisco">sw2# show l2vpn evpn mac evi 1151

MAC Address    EVI   VLAN  ESI                      Ether Tag  Next Hop(s)
-------------- ----- ----- ------------------------ ---------- ---------------
aabb.cc00.2400 1151  1151  0000.0000.0000.0000.0000 0          Gi1/0/4:1151
aabb.cc00.2700 1151  1151  0000.0000.0000.0000.0000 0          1.1.1.3
aabb.cc00.2f10 1151  1151  0000.0000.0000.0000.0000 0          1.1.1.4</pre>

<div class="success-box">
    <strong>Cross-Vendor MAC Learning Confirmed:</strong> All VTEPs see each other's client MACs. Cisco learns Versa MACs via EVPN Type-2, Cumulus learns all remote MACs via FDB with <code>extern_learn</code> flag.
</div>

<div class="page-break"></div>

<!-- ===================== SECTION 11 ===================== -->
<h2 id="s11">11. VXLAN-GBP Interoperability Issue</h2>

<div class="danger-box">
    <strong>Issue ID: NET-2026-001</strong><br>
    <strong>Severity:</strong> High &mdash; Complete traffic loss between Cumulus and Versa VTEPs<br>
    <strong>Symptom:</strong> Ping from Cumulus client (192.168.1.12) to Versa client (192.168.1.10) fails with 100% packet loss, while EVPN control plane is fully operational.<br>
    <strong>Root Cause:</strong> Versa FlexVNF sends VXLAN packets with GBP (Group Based Policy) flags. Linux kernel VXLAN driver silently drops packets with GBP flags unless the VXLAN interface is created with the <code>gbp</code> option.
</div>

<h3>11.1 What is VXLAN-GBP?</h3>

<p><strong>VXLAN-GBP</strong> (Group Based Policy) is an extension to the standard VXLAN header defined in <em>draft-smith-vxlan-group-policy</em>. It adds a <strong>Group Policy ID</strong> (also called SGT - Security Group Tag) to the VXLAN header, enabling micro-segmentation across the VXLAN fabric.</p>

<h4>Standard VXLAN Header (RFC 7348)</h4>
<div class="bit-diagram">
<pre style="background:none;border:none;margin:0;padding:0;color:#333;">
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|R|R|R|R|<b style="color:#1565c0">I</b>|R|R|R|         Reserved (24 bits)                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|              VXLAN Network Identifier (VNI)   |   Reserved    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Flags byte = 0x08  (only I-bit set, indicating valid VNI)
</pre>
</div>

<h4>VXLAN-GBP Header (draft-smith-vxlan-group-policy)</h4>
<div class="bit-diagram">
<pre style="background:none;border:none;margin:0;padding:0;color:#333;">
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|<b style="color:#e53935">G</b>|R|R|<b style="color:#e53935">D</b>|<b style="color:#1565c0">I</b>|R|R|<b style="color:#e53935">A</b>|<b style="color:#e53935"> Group Policy ID (16 bits) </b>|   Reserved    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|              VXLAN Network Identifier (VNI)   |   Reserved    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

<b style="color:#e53935">G-bit (bit 0):</b>  GBP Extension flag. When set (1), indicates GBP header is present.
<b style="color:#e53935">D-bit (bit 3):</b>  "Don't Learn" flag. Tells remote VTEP not to learn this source MAC.
<b style="color:#1565c0">I-bit (bit 4):</b>  VXLAN VNI valid flag (same as standard VXLAN).
<b style="color:#e53935">A-bit (bit 7):</b>  "Applied" flag. Policy was already applied at source.
<b style="color:#e53935">Group Policy ID:</b> 16-bit SGT (Security Group Tag) for micro-segmentation.

Flags byte = 0x88  (G-bit + I-bit set, GBP active)
</pre>
</div>

<h3>11.2 Packet Capture Evidence</h3>

<p>The following evidence was captured from a pcap taken on the sw1 spine (between Cumulus 1.1.1.5 and Versa 1.1.1.4):</p>

<h4>tshark Analysis - VXLAN Flags Comparison</h4>
<pre class="pcap"># tshark -r BGP-EVPN.pcap -Y "vxlan" -T fields -e frame.number -e ip.src -e ip.dst -e vxlan.flags -e vxlan.vni

Frame  Source                        Destination                    Flags   VNI
-----  ------                        -----------                    -----   ------
11     1.1.1.5 (Cumulus->)           1.1.1.4 (->Versa)             0x0800  401151
12     1.1.1.4 (Versa->)            1.1.1.5 (->Cumulus)            0x8808  401151
13     1.1.1.5 (Cumulus->)           1.1.1.4 (->Versa)             0x0800  401151
14     1.1.1.4 (Versa->)            1.1.1.5 (->Cumulus)            0x8808  401151
...
(pattern repeats for ALL packets)</pre>

<div class="danger-box">
    <strong>Key Finding:</strong> Every VXLAN packet from Versa (1.1.1.4) has flags = <code>0x8808</code> (GBP enabled), while Cumulus and Cisco send <code>0x0800</code> (standard). The <code>0x88</code> in the first byte means <strong>both G-bit and I-bit</strong> are set. The <code>0x08</code> in the second byte is the Group Policy ID = 8.
</div>

<h4>Raw Hex Dump - VXLAN Header Comparison</h4>

<p><strong>Packet 11</strong> &mdash; Cumulus (1.1.1.5) &rarr; Versa (1.1.1.4) &mdash; <span class="badge badge-success">Standard VXLAN</span></p>
<pre class="pcap">Offset  Hex                                              ASCII
------  ------------------------------------------------ ----------------
0x0000  52 54 00 20 06 21 52 54 00 db 28 d1 08 00 45 00  RT. .!RT..(...E.
0x0010  00 96 5a 0a 00 00 3f 11 1d 43 01 01 01 05 01 01  ..Z...?..C......
0x0020  01 04 a5 43 12 b5 00 82 e1 2e <span class="hex-highlight-green">08 00 00 00</span> 06 1e  ...C............
0x0030  ff 00 aa bb cc 00 2f 10 aa bb cc 00 30 10 08 00  ....../.....0...
0x0040  45 00 00 64 ... (inner IP: 192.168.1.12 -> 192.168.1.10 ICMP echo)

         VXLAN Header: <span class="hex-highlight-green">08</span> 00 00 00  |  VNI: 06 1e ff (401151)
         Flags byte:   0x08 = 0000 1000 = I-bit only (standard VXLAN)</pre>

<p><strong>Packet 12</strong> &mdash; Versa (1.1.1.4) &rarr; Cumulus (1.1.1.5) &mdash; <span class="badge badge-danger">VXLAN-GBP</span></p>
<pre class="pcap">Offset  Hex                                              ASCII
------  ------------------------------------------------ ----------------
0x0000  52 54 00 db 28 d1 52 54 00 20 06 21 08 00 45 00  RT..(.RT. .!..E.
0x0010  00 96 00 00 00 00 ff 11 b7 4c 01 01 01 04 01 01  .........L......
0x0020  01 05 12 b5 12 b5 00 82 f3 b4 <span class="hex-highlight-red">88 08 00 00</span> 06 1e  ................
0x0030  ff 00 aa bb cc 00 30 10 aa bb cc 00 2f 10 08 00  ......0...../...
0x0040  45 00 00 64 ... (inner IP: 192.168.1.10 -> 192.168.1.12 ICMP reply)

         VXLAN Header: <span class="hex-highlight-red">88</span> 08 00 00  |  VNI: 06 1e ff (401151)
         Flags byte:   0x88 = 1000 1000 = G-bit + I-bit (GBP ENABLED!)
         Group Policy ID: 0x08 = SGT 8</pre>

<h3>11.3 Why This Causes Traffic Failure</h3>

<p>The Linux kernel VXLAN driver has strict validation of VXLAN header flags:</p>

<ul>
    <li>When a VXLAN interface is created <strong>without</strong> the <code>gbp</code> option, the kernel expects flags byte = <code>0x08</code> (I-bit only).</li>
    <li>If the kernel receives a VXLAN packet with the G-bit set (<code>0x88</code>), it treats the packet as having invalid/unknown flags.</li>
    <li>The kernel <strong>silently drops</strong> the packet &mdash; no error, no log, no ICMP unreachable.</li>
    <li>This means the ICMP echo request from Cumulus reaches Versa, the ICMP echo reply comes back, but the reply is dropped at the Cumulus VXLAN decapsulation layer.</li>
</ul>

<h4>Traffic Flow Diagram (Before Fix)</h4>
<div class="diagram-container">
<div class="diagram">
Cumulus Client               Cumulus VTEP                   Versa VTEP              Versa Client
192.168.1.12                 1.1.1.5                        1.1.1.4                 192.168.1.10
     |                           |                              |                        |
     |--- ICMP Echo Request ---->|                              |                        |
     |                           |== VXLAN (flags=0x08) =======>|                        |
     |                           |     Standard VXLAN           |--- ICMP Echo Req ----->|
     |                           |                              |                        |
     |                           |                              |<--- ICMP Echo Reply ----|
     |                           |<== VXLAN (flags=0x88) =======|                        |
     |                           |     GBP ENABLED!             |                        |
     |                           |                              |                        |
     |                        [DROPPED]                         |                        |
     |                     Kernel rejects                       |                        |
     |                   GBP flag on non-GBP                    |                        |
     |                      VXLAN interface                     |                        |
     |                           |                              |                        |
     |     100% packet loss      |                              |                        |
</div>
</div>

<div class="info-box">
    <strong>Important:</strong> This issue only affects Cumulus (Linux kernel VXLAN). Cisco IOS-XE silently ignores the GBP bits and processes the packet normally, which is why Cisco-to-Versa traffic worked without issues.
</div>

<div class="page-break"></div>

<!-- ===================== SECTION 12 ===================== -->
<h2 id="s12">12. VXLAN-GBP Fix &amp; Resolution</h2>

<h3>12.1 Root Cause Summary</h3>

<table>
    <tr><th>Attribute</th><th>Detail</th></tr>
    <tr><td>Affected Traffic</td><td>Cumulus &harr; Versa (both directions of data plane)</td></tr>
    <tr><td>Root Cause</td><td>Versa FlexVNF always sends VXLAN-GBP headers (flags=0x88). Linux kernel drops GBP-flagged packets on non-GBP VXLAN interfaces.</td></tr>
    <tr><td>Control Plane</td><td>Not affected. BGP EVPN routes exchanged correctly.</td></tr>
    <tr><td>Cisco Impact</td><td>None. IOS-XE ignores GBP bits in received packets.</td></tr>
    <tr><td>Fix Required On</td><td>Cumulus Linux only</td></tr>
</table>

<h3>12.2 Resolution - Enable GBP on Cumulus VXLAN Interface</h3>

<p>The fix requires recreating the vxlan48 interface with the <code>gbp</code> flag. This cannot be added to an existing interface &mdash; it must be specified at creation time.</p>

<h4>Step 1: Delete and recreate vxlan48 with GBP</h4>
<pre class="cumulus"># Remove existing vxlan48
sudo ip link del vxlan48

# Recreate with GBP flag
sudo ip link add vxlan48 type vxlan id 401151 local 1.1.1.5 dstport 4789 nolearning gbp

# Bring interface up
sudo ip link set vxlan48 up</pre>

<h4>Step 2: Restore bridge and VLAN settings</h4>
<pre class="cumulus"># Add vxlan48 back to bridge
sudo ip link set vxlan48 master br_default

# Fix VLAN mapping (CRITICAL - must be VLAN 1151, not default VLAN 1)
sudo bridge vlan del vid 1 dev vxlan48
sudo bridge vlan add vid 1151 dev vxlan48 pvid untagged

# Restore bridge port settings
sudo bridge link set dev vxlan48 state 3          # forwarding
sudo ip link set vxlan48 mtu 9216                 # match fabric MTU
sudo bridge link set dev vxlan48 learning off      # EVPN controls FDB
sudo bridge link set dev vxlan48 neigh_suppress on # ARP suppression
sudo bridge link set dev vxlan48 vlan_tunnel on    # VLAN-VNI mapping</pre>

<h4>Step 3: Run NVUE apply to synchronize state</h4>
<pre class="cumulus"># NVUE apply preserves the GBP flag if vxlan48 already exists with it
nv config apply -y</pre>

<h4>Step 4: Verify</h4>
<pre class="cumulus"># Confirm GBP is enabled
ip -d link show vxlan48 | grep gbp

# Confirm VLAN mapping
bridge vlan show dev vxlan48

# Confirm EVPN VNI maps to VLAN 1151 (not VLAN 1!)
sudo vtysh -c "show evpn vni 401151"</pre>

<div class="warning-box">
    <strong>VLAN Mapping Pitfall:</strong> When vxlan48 is manually recreated and added back to <code>br_default</code>, the bridge assigns VLAN 1 as the default PVID. This causes VNI 401151 to map to VLAN 1 instead of VLAN 1151, breaking ALL VXLAN traffic (not just Versa). You <strong>must</strong> explicitly delete VID 1 and add VID 1151 as PVID.
</div>

<div class="warning-box">
    <strong>Persistence Note:</strong> The manual <code>ip link</code> recreation is <strong>not persistent across reboots</strong>. After reboot, NVUE will recreate vxlan48 without GBP. To make this permanent, edit <code>/etc/network/interfaces</code> or configure a post-boot script. NVUE does not currently expose a <code>gbp</code> option for VXLAN interfaces.
</div>

<h3>12.3 Post-Fix Verification</h3>

<pre class="cumulus">cumulus@cumulus:~$ ip -d link show vxlan48

14: vxlan48: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9216
    master br_default state UNKNOWN
    vxlan id 401151 local 1.1.1.5 srcport 0 0 dstport 4789
    nolearning ttl 64 ageing 300 udpcsum <b>gbp</b>
    bridge_slave state <b>forwarding</b> learning <b>off</b> neigh_suppress <b>on</b>

cumulus@cumulus:~$ bridge vlan show dev vxlan48
port     vlan ids
vxlan48  <b>1151 PVID Egress Untagged</b>

cumulus@cumulus:~$ sudo vtysh -c "show evpn vni 401151"
VNI: 401151
 Type: L2
 Vlan: <b>1151</b>          &lt;-- Must be 1151, NOT 1
 Bridge: br_default
 Remote VTEPs:
  1.1.1.4 flood: HER
  1.1.1.3 flood: HER
  1.1.1.2 flood: HER</pre>

<div class="success-box">
    <strong>Resolution Confirmed:</strong> After enabling GBP on vxlan48, Cumulus correctly accepts VXLAN packets with GBP flags from Versa. Traffic flows successfully between all VTEPs including Cumulus &harr; Versa.
</div>

<div class="page-break"></div>

<!-- ===================== SECTION 13 ===================== -->
<h2 id="s13">13. Troubleshooting Commands</h2>

<h3>13.1 Cisco IOS-XE Commands</h3>
<table>
    <tr>
        <th>Command</th>
        <th>Purpose</th>
    </tr>
    <tr><td><code>show bgp l2vpn evpn summary</code></td><td>BGP EVPN neighbor status</td></tr>
    <tr><td><code>show bgp l2vpn evpn route-type 2</code></td><td>MAC/IP routes (Type-2)</td></tr>
    <tr><td><code>show bgp l2vpn evpn route-type 3</code></td><td>IMET routes (Type-3)</td></tr>
    <tr><td><code>show nve peers</code></td><td>VXLAN tunnel peer status</td></tr>
    <tr><td><code>show nve vni</code></td><td>VNI status and mappings</td></tr>
    <tr><td><code>show l2vpn evpn mac evi &lt;id&gt;</code></td><td>EVPN learned MACs per EVI</td></tr>
    <tr><td><code>show l2vpn evpn evi detail</code></td><td>Detailed EVI information</td></tr>
    <tr><td><code>show l2fib bridge-domain &lt;vni&gt;</code></td><td>Data plane FDB entries</td></tr>
    <tr><td><code>show ip ospf neighbor</code></td><td>OSPF adjacency status</td></tr>
</table>

<h3>13.2 Cumulus Linux (NVIDIA) Commands</h3>
<table>
    <tr>
        <th>Command</th>
        <th>Purpose</th>
    </tr>
    <tr><td><code>sudo vtysh -c "show bgp l2vpn evpn summary"</code></td><td>BGP EVPN neighbor status</td></tr>
    <tr><td><code>sudo vtysh -c "show bgp l2vpn evpn route vni &lt;id&gt;"</code></td><td>EVPN routes per VNI</td></tr>
    <tr><td><code>sudo vtysh -c "show evpn vni &lt;id&gt;"</code></td><td>VNI status (VLAN mapping, remote VTEPs)</td></tr>
    <tr><td><code>sudo vtysh -c "show evpn arp-cache vni &lt;id&gt;"</code></td><td>EVPN ARP/ND cache</td></tr>
    <tr><td><code>sudo vtysh -c "show evpn mac vni &lt;id&gt;"</code></td><td>EVPN MAC table per VNI</td></tr>
    <tr><td><code>sudo vtysh -c "show ip ospf neighbor"</code></td><td>OSPF adjacency status</td></tr>
    <tr><td><code>bridge fdb show dev vxlan48</code></td><td>Bridge FDB (MAC table) for VXLAN</td></tr>
    <tr><td><code>bridge vlan show dev vxlan48</code></td><td>VLAN membership on VXLAN interface</td></tr>
    <tr><td><code>ip -d link show vxlan48</code></td><td>Detailed VXLAN interface (check GBP flag)</td></tr>
    <tr><td><code>nv config show --output commands</code></td><td>Running config in NVUE set format</td></tr>
    <tr><td><code>ip -s link show vxlan48</code></td><td>VXLAN interface packet/byte counters</td></tr>
    <tr><td><code>sudo tcpdump -i swp1 udp port 4789 -nn</code></td><td>Capture VXLAN underlay traffic</td></tr>
</table>

<h3>13.3 Versa FlexVNF Commands</h3>
<table>
    <tr>
        <th>Command</th>
        <th>Purpose</th>
    </tr>
    <tr><td><code>show bgp summary</code></td><td>BGP neighbor status</td></tr>
    <tr><td><code>show bridge</code></td><td>MAC address table (bridge FDB)</td></tr>
    <tr><td><code>show bridge-evpn</code></td><td>EVPN instance status</td></tr>
    <tr><td><code>show bridge-domain</code></td><td>Bridge domain details</td></tr>
    <tr><td><code>show ospf route routing-instance Underlay</code></td><td>OSPF routes in underlay VR</td></tr>
    <tr><td><code>show route routing-instance Underlay &lt;prefix&gt;</code></td><td>Route lookup in underlay</td></tr>
    <tr><td><code>ping &lt;ip&gt; routing-instance Underlay count 3</code></td><td>Ping from underlay VR</td></tr>
    <tr><td><code>show configuration routing-instances</code></td><td>Routing instance configuration</td></tr>
</table>

<div class="warning-box">
    <strong>Important Note - Remote MAC Display on Cisco:</strong><br>
    On IOS-XE, remote MACs learned via EVPN appear in <code>show l2vpn evpn mac</code> and <code>show l2fib bridge-domain</code>. They do <strong>NOT</strong> appear in <code>show mac address-table</code> (locally learned MACs only). This is expected behavior.
</div>

<div class="page-break"></div>

<!-- ===================== SECTION 14 ===================== -->
<h2 id="s14">14. Summary &amp; Lessons Learned</h2>

<p>The multi-vendor EVPN VXLAN fabric with Cisco Catalyst 9300, Versa FlexVNF, and Cumulus Linux (NVIDIA) is <strong>fully operational</strong>. Layer 2 extension of VLAN 1151 (VNI 401151) works between all four leaf VTEPs:</p>

<table>
    <tr>
        <th>VTEP</th>
        <th>IP</th>
        <th>Vendor</th>
        <th>Status</th>
    </tr>
    <tr><td>sw2</td><td>1.1.1.2</td><td><span class="vendor-tag vendor-cisco">Cisco</span></td><td><span class="badge badge-success">Operational</span></td></tr>
    <tr><td>sw3</td><td>1.1.1.3</td><td><span class="vendor-tag vendor-cisco">Cisco</span></td><td><span class="badge badge-success">Operational</span></td></tr>
    <tr><td>Versa</td><td>1.1.1.4</td><td><span class="vendor-tag vendor-versa">Versa</span></td><td><span class="badge badge-success">Operational</span></td></tr>
    <tr><td>Cumulus</td><td>1.1.1.5</td><td><span class="vendor-tag vendor-cumulus">Cumulus</span></td><td><span class="badge badge-success">Operational</span></td></tr>
</table>

<h3>14.1 Key Lessons Learned</h3>

<table>
    <tr><th>#</th><th>Issue</th><th>Impact</th><th>Resolution</th></tr>
    <tr>
        <td>1</td>
        <td><strong>VXLAN-GBP Flag Mismatch</strong></td>
        <td>Complete Cumulus &harr; Versa data plane failure. Control plane unaffected.</td>
        <td>Enable <code>gbp</code> flag on Cumulus VXLAN interface at creation time. Linux kernel drops GBP-flagged packets on non-GBP interfaces.</td>
    </tr>
    <tr>
        <td>2</td>
        <td><strong>VLAN-VNI Mapping after VXLAN Recreation</strong></td>
        <td>VNI maps to VLAN 1 (default PVID) instead of VLAN 1151, breaking all VXLAN traffic.</td>
        <td>After recreating vxlan interface, explicitly set correct VLAN as PVID: <code>bridge vlan del vid 1</code> then <code>bridge vlan add vid 1151 pvid untagged</code>.</td>
    </tr>
    <tr>
        <td>3</td>
        <td><strong>OSPF MTU Mismatch</strong></td>
        <td>OSPF stuck in ExStart/DBD between Cisco (MTU 1550) and Cumulus (MTU 9216).</td>
        <td>Configure <code>ip ospf mtu-ignore</code> on both sides, or match MTU values.</td>
    </tr>
    <tr>
        <td>4</td>
        <td><strong>Cumulus NVUE OSPF Context</strong></td>
        <td>OSPF daemon doesn't activate if configured only at global level.</td>
        <td>Must enable OSPF under VRF default context: <code>nv set vrf default router ospf enable on</code>.</td>
    </tr>
    <tr>
        <td>5</td>
        <td><strong>Versa Route Target</strong></td>
        <td>Versa exports non-standard RT (2:2) alongside standard RT (1151:1).</td>
        <td>Ensure all Cisco VTEPs import RT 1151:1 (Versa also exports this). Optionally import 2:2 for completeness.</td>
    </tr>
</table>

<h3>14.2 Recommendations</h3>

<ul>
    <li><strong>GBP Persistence:</strong> Configure a post-boot script or edit <code>/etc/network/interfaces</code> to ensure the <code>gbp</code> flag survives Cumulus reboots. NVUE does not currently support the GBP option natively.</li>
    <li><strong>Monitoring:</strong> Monitor VXLAN interface flags after every <code>nv config apply</code> to ensure GBP is preserved.</li>
    <li><strong>Packet Captures:</strong> When troubleshooting VXLAN interop issues, always check the VXLAN flags byte in pcap. Different vendors may set different extension flags (GBP, GPE, etc.).</li>
    <li><strong>MTU Consistency:</strong> Standardize underlay MTU across all vendors to avoid OSPF and VXLAN fragmentation issues.</li>
</ul>

<div class="footer">
    <p><strong>INTERNAL ENGINEERING DOCUMENT</strong><br>
    Multi-Vendor EVPN VXLAN Integration &mdash; Cisco / Versa / Cumulus<br>
    Version 2.0 &mdash; February 10, 2026<br>
    Generated with Claude Code</p>
</div>

</body>
</html>
